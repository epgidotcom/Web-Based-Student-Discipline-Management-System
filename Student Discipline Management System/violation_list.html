<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SDMS - Violation List</title>

  <!-- Global + Page CSS -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/violation_list.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- helpers -->
  <style>
    .is-hidden{display:none!important}
    .past-offense-box{background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;max-height:140px;overflow:auto}
    .po-list{margin:6px 0 0;padding-left:18px}
    .po-list li{margin:2px 0}
  </style>
</head>
<body>

<!-- Sidebar (drawer on mobile) -->
<nav class="sidebar" id="sidebar" aria-hidden="true">
  <img src="images/mpnag_logo.png" alt="MPNAG Logo">
  <a href="dashboard.html"><i class="fa fa-gauge"></i> Dashboard</a>
  <a href="student_list.html"><i class="fa fa-users"></i> Student List</a>
  <a href="violation_list.html" class="active"><i class="fa fa-exclamation-triangle"></i> Violation List</a>
  <a href="calendar.html"><i class="fa fa-calendar"></i> Calendar</a>
  <a href="SMS.html"><i class="fa fa-message"></i> Message</a>
  <a href="account.html"><i class="fa fa-user-plus"></i> Accounts</a>
  <div class="sidebar-footer">
    <button id="logoutBtn" class="logout-side" type="button">
      <i class="fa fa-sign-out-alt" aria-hidden="true"></i>
      <span>Logout</span>
    </button>
  </div>
</nav>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <button class="menu-btn" aria-label="Open menu" aria-controls="sidebar" aria-expanded="false">
      <i class="fa fa-bars" aria-hidden="true"></i><span> Menu</span>
    </button>
    <h1>Student Discipline Management System</h1>

    <div class="user-area">
      <button class="user-chip" id="userChip" type="button" aria-label="Current user">
        <span class="user-avatar" id="userAvatar">A</span>
        <span class="user-name" id="userName">Admin</span>
      </button>
    </div>
  </div>

  <div class="widget">
    <h3>Violation List</h3>

    <button id="addViolationBtn" class="add-btn"><i class="fa fa-plus"></i> Add Violation</button>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Search violation..." onkeyup="searchViolation()">
      <button type="button" class="search-btn"><i class="fa fa-search"></i> <span>Search</span></button>
    </div>

    <!-- Wrap table to avoid page-wide horizontal scroll on phones -->
    <div class="table-wrap">
      <table id="violationTable">
        <thead>
          <tr>
            <th>Student Name</th>
            <th>Grade &amp; Section</th>
            <th>Past Offense</th>
            <th>Date</th>
            <!-- Description intentionally hidden from the table -->
            <th>Violation Type</th>
            <th>Sanction</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add/Edit Violation Modal -->
<div id="violationModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 id="modalTitle">Add Violation</h2>

    <form id="violationForm">
      <input type="hidden" id="editIndex">

      <!-- 1) Student Name -->
      <label>Student Name:</label>
      <input type="text" id="studentName" autocomplete="off" required>

      <!-- 2) Grade & Section -->
      <label>Grade &amp; Section:</label>
      <input type="text" id="gradeSection" placeholder="e.g., Grade 10 - St. Matthew" required>

      <!-- 3) Past Offense (hidden until a student name is entered/selected) -->
      <div id="pastOffenseWrap" class="is-hidden">
        <label>Past Offense:</label>
        <div id="pastOffenseBox" class="past-offense-box">
          <p id="pastOffenseEmpty" class="hint">No past offenses.</p>
          <ul id="pastOffenseList" class="po-list"></ul>
        </div>
      </div>

      <!-- 4) Date -->
      <label>Date:</label>
      <input type="date" id="date" required>

      <!-- 5) Violation's Description (stored, not in table) -->
      <label>Violation's Description:</label>
      <textarea id="description" rows="3" placeholder="Describe the violation..." required></textarea>

      <!-- 6) Violation Type -->
      <label>Violation Type:</label>
      <select id="violationType" required>
        <option value="" disabled selected>Select type</option>
        <option value="Bullying">Bullying</option>
        <option value="Cheating">Cheating</option>
        <option value="Vandalism">Vandalism</option>
        <option value="Tardiness">Tardiness</option>
        <option value="Improper Uniform">Improper Uniform</option>
        <option value="Others">Others</option>
      </select>

      <!-- 7) Sanction -->
      <label>Sanction:</label>
      <select id="sanction" required>
        <option value="" disabled selected>Select sanction</option>
        <option value="Verbal Warning">Verbal Warning</option>
        <option value="Written Reprimand">Written Reprimand</option>
        <option value="Detention">Detention</option>
        <option value="Community Service">Community Service</option>
        <option value="Parent Conference">Parent Conference</option>
        <option value="Suspension">Suspension</option>
      </select>

      <!-- (Optional) Evidence -->
      <div class="evidence-uploader" id="evidenceUploader">
        <div class="head"><strong>Evidence (optional)</strong></div>
        <div class="evidence-preview is-hidden" id="evidencePreview"></div>
        <div class="drop" id="evidenceDrop">
          <i class="fa fa-paperclip"></i>
          <p>Drag & drop or choose 1–3 images (JPG/PNG, ~2MB each). We’ll auto-resize.</p>
          <button type="button" class="btn" id="evidenceChoose">Choose file(s)</button>
          <input type="file" id="evidenceInput" accept="image/*" multiple class="is-hidden">
          <div class="evidence-actions is-hidden" id="evidenceActions">
            <button type="button" class="btn" id="evidenceChange"><i class="fa fa-camera"></i> Add more</button>
            <button type="button" class="btn danger" id="evidenceClear"><i class="fa fa-trash"></i> Remove all</button>
          </div>
        </div>
      </div>

      <button type="submit" class="save-btn">Save</button>
    </form>
  </div>
</div>

<!-- View Violation Modal -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Violation Details</h2>

    <p><strong>Student:</strong> <span id="viewStudent"></span></p>
    <p><strong>Grade &amp; Section:</strong> <span id="viewGradeSection"></span></p>

    <div id="viewPastOffenseRow" class="is-hidden">
      <p><strong>Past Offense:</strong> <span id="viewPastOffense"></span></p>
    </div>

    <p><strong>Date:</strong> <span id="viewDate"></span></p>
    <p><strong>Violation's Description:</strong> <span id="viewDescription"></span></p>
    <p><strong>Violation Type:</strong> <span id="viewViolationType"></span></p>
    <p><strong>Sanction:</strong> <span id="viewSanction"></span></p>

    <div id="viewEvidenceWrap" class="is-hidden" style="margin-top:10px;">
      <strong>Evidence:</strong>
      <div id="viewEvidence" class="evidence-preview" style="margin-top:6px;"></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="js/config.js"></script>
<script src="js/main.js" defer></script>
<script src="js/violation_list.js" defer></script>

<!-- Inline page logic (self-contained) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  /* ===== Drawer fallback (guarded) ===== */
  var sidebar  = document.getElementById('sidebar');
  var menuBtn  = document.querySelector('.menu-btn');
  var backdrop = document.getElementById('backdrop'); // may not exist

  if (menuBtn && sidebar && !menuBtn.dataset.bound) {
    function setOpen(open){
      sidebar.classList.toggle('open', open);
      if (backdrop) backdrop.classList.toggle('show', open);
      document.body.style.overflow = open ? 'hidden' : '';
      menuBtn.setAttribute('aria-expanded', String(open));
    }
    function toggle(){ setOpen(!sidebar.classList.contains('open')); }
    menuBtn.addEventListener('click', toggle);
    if (backdrop) backdrop.addEventListener('click', function(){ setOpen(false); });
    window.addEventListener('keydown', function(e){ if(e.key === 'Escape') setOpen(false); });
    window.addEventListener('resize', function(){ if (window.innerWidth >= 769) setOpen(false); });
    menuBtn.dataset.bound = '1';
  }

  /* ===== Elements ===== */
  var violations = [];

  var violationForm   = document.getElementById("violationForm");
  var violationTable  = document.getElementById("violationTable") ? document.getElementById("violationTable").querySelector("tbody") : null;
  var addViolationBtn = document.getElementById("addViolationBtn");
  var violationModal  = document.getElementById("violationModal");
  var viewModal       = document.getElementById("viewModal");
  var modalTitle      = document.getElementById("modalTitle");
  var closeBtns       = document.querySelectorAll(".close-btn");

  var studentNameInput   = document.getElementById("studentName");
  var gradeSectionInput  = document.getElementById("gradeSection");
  var violationTypeInput = document.getElementById("violationType");
  var sanctionInput      = document.getElementById("sanction");
  var descriptionInput   = document.getElementById("description");
  var dateInput          = document.getElementById("date");
  var editIndexInput     = document.getElementById("editIndex");

  // Past Offense (read-only)
  var pastOffenseWrap  = document.getElementById("pastOffenseWrap");
  var pastOffenseList  = document.getElementById("pastOffenseList");
  var pastOffenseEmpty = document.getElementById("pastOffenseEmpty");

  // View modal
  var viewStudent        = document.getElementById("viewStudent");
  var viewGradeSection   = document.getElementById("viewGradeSection");
  var viewPastOffenseRow = document.getElementById("viewPastOffenseRow");
  var viewPastOffense    = document.getElementById("viewPastOffense");
  var viewViolationType  = document.getElementById("viewViolationType");
  var viewSanction       = document.getElementById("viewSanction");
  var viewDescription    = document.getElementById("viewDescription");
  var viewDate           = document.getElementById("viewDate");
  var viewEvidenceWrap   = document.getElementById("viewEvidenceWrap");
  var viewEvidenceBox    = document.getElementById("viewEvidence");

  /* ===== Evidence uploader ===== */
  var ev = {
    input:  document.getElementById("evidenceInput"),
    drop:   document.getElementById("evidenceDrop"),
    choose: document.getElementById("evidenceChoose"),
    change: document.getElementById("evidenceChange"),
    clear:  document.getElementById("evidenceClear"),
    actions:document.getElementById("evidenceActions"),
    preview:document.getElementById("evidencePreview"),
  };
  var evidenceData = [];

  function fileToDataURL(file, maxEdge, quality) {
    if (!maxEdge) maxEdge = 1024;
    if (!quality) quality = 0.85;
    return new Promise(function(resolve){
      var url = URL.createObjectURL(file);
      var img = new Image();
      img.onload = function(){
        var scale = Math.min(1, maxEdge / Math.max(img.width, img.height));
        var canvas = document.createElement("canvas");
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        URL.revokeObjectURL(url);
        resolve(canvas.toDataURL("image/jpeg", quality));
      };
      img.src = url;
    });
  }

  function renderEvidenceThumbs() {
    if (!ev.preview || !ev.actions || !ev.drop) return;
    ev.preview.innerHTML = "";
    for (var i=0;i<evidenceData.length;i++){
      var src = evidenceData[i];
      var img = document.createElement("img");
      img.src = src; img.className = "evidence-thumb"; img.alt = "Evidence " + (i+1);
      img.title = "Click to open";
      img.addEventListener("click", function(s){ return function(){ window.open(s, "_blank"); }; }(src));
      ev.preview.appendChild(img);
    }
    var has = evidenceData.length > 0;
    if (has) {
      ev.preview.classList.remove("is-hidden");
      ev.actions.classList.remove("is-hidden");
      ev.drop.classList.add("is-hidden");
    } else {
      ev.preview.classList.add("is-hidden");
      ev.actions.classList.add("is-hidden");
      ev.drop.classList.remove("is-hidden");
    }
  }

  async function addFiles(files) {
    if (!files) return;
    for (var i=0;i<files.length;i++){
      var file = files[i];
      if (!/^image\/(png|jpe?g|webp)$/i.test(file.type)) continue;
      if (evidenceData.length >= 3) { alert("You can add up to 3 images."); break; }
      var dataUrl = await fileToDataURL(file, 1024, 0.85);
      evidenceData.push(dataUrl);
    }
    renderEvidenceThumbs();
  }
  function clearEvidence() { evidenceData = []; renderEvidenceThumbs(); }

  function initEvidenceUploader() {
    if (!ev.input) return;
    if (ev.choose) ev.choose.addEventListener("click", function(){ ev.input.click(); });
    if (ev.change) ev.change.addEventListener("click", function(){ ev.input.click(); });
    if (ev.clear)  ev.clear .addEventListener("click", clearEvidence);
    ev.input.addEventListener("change", function(e){ addFiles(e.target.files); });

    if (ev.drop) {
      ["dragenter","dragover"].forEach(function(t){
        ev.drop.addEventListener(t, function(e){ e.preventDefault(); ev.drop.classList.add("dragover"); });
      });
      ["dragleave","drop"].forEach(function(t){
        ev.drop.addEventListener(t, function(e){ e.preventDefault(); ev.drop.classList.remove("dragover"); });
      });
      ev.drop.addEventListener("drop", function(e){ addFiles(e.dataTransfer.files); });
    }

    window._evidence = {
      get: function(){ return evidenceData.slice(); },
      set: function(arr){ evidenceData = (arr || []).slice(0,3); renderEvidenceThumbs(); },
      clear: clearEvidence,
      hasAny: function(){ return evidenceData.length > 0; }
    };
  }
  initEvidenceUploader();

  /* ===== Past Offense data (mock now, API-ready) ===== */
  var USE_API  = false;                // set to true when backend is ready
  var API_BASE = '/api';
  var STORAGE_KEY = 'sdms_mock_past_offenses_v1';

  var MockPastOffenseStore = {
    _data: null,
    _load: function(){
      if (this._data) return this._data;
      try {
        this._data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
          'Juan Dela Cruz': ['Tardiness — 2025-08-01','Improper Uniform — 2025-09-10'],
          'Maria Santos': [],
          'Hee, Wael N': ['Not Wearing Uniform — 2025-09-20']
        };
      } catch (e) { this._data = {}; }
      return this._data;
    },
    _save: function(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(this._data)); },
    getByName: async function(name){
      var data = this._load();
      var key = null;
      var target = String(name || '').trim().toLowerCase();
      var keys = Object.keys(data);
      for (var i=0;i<keys.length;i++){
        if (keys[i].toLowerCase() === target) { key = keys[i]; break; }
      }
      return key ? data[key].slice() : [];
    },
    addOffense: async function(name, label){
      var data = this._load();
      var nm = String(name || '').trim();
      if (!nm) return [];
      // find exact ignoring case
      var keys = Object.keys(data);
      var found = nm;
      for (var i=0;i<keys.length;i++){
        if (keys[i].toLowerCase() === nm.toLowerCase()) { found = keys[i]; break; }
      }
      data[found] = data[found] || [];
      data[found].push(label);
      this._save();
      return data[found].slice();
    }
  };

  var ApiPastOffenseStore = {
    getByName: async function(name){
      try {
        var res = await fetch(API_BASE + '/past-offenses?name=' + encodeURIComponent(name));
        if (!res.ok) return [];
        var data = await res.json();
        return Array.isArray(data) ? data : [];
      } catch (e) { return []; }
    },
    addOffense: async function(name, label, dateISO){
      try {
        var res = await fetch(API_BASE + '/past-offenses', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name: name, label: label, date: dateISO })
        });
        if (!res.ok) return [];
        var data = await res.json();
        return Array.isArray(data) ? data : [];
      } catch (e) { return []; }
    }
  };

  var PastOffenseService = USE_API ? ApiPastOffenseStore : MockPastOffenseStore;

  function debounce(fn, ms){
    var t;
    return function(){
      var args = arguments;
      clearTimeout(t);
      t = setTimeout(function(){ fn.apply(null, args); }, ms || 300);
    };
  }

  async function refreshPastOffenseUI() {
    if (!pastOffenseWrap || !pastOffenseList || !pastOffenseEmpty) return;

    var name = (studentNameInput && studentNameInput.value || '').trim();

    if (!name) {
      pastOffenseWrap.classList.add('is-hidden');
      pastOffenseList.innerHTML = '';
      pastOffenseEmpty.classList.remove('is-hidden');
      pastOffenseEmpty.textContent = 'No past offenses.';
      return;
    }

    pastOffenseWrap.classList.remove('is-hidden');

    var offenses = await PastOffenseService.getByName(name);

    pastOffenseList.innerHTML = '';
    if (!offenses.length) {
      pastOffenseEmpty.classList.remove('is-hidden');
      pastOffenseEmpty.textContent = 'No past offenses.';
    } else {
      pastOffenseEmpty.classList.add('is-hidden');
      for (var i=0;i<offenses.length;i++){
        var li = document.createElement('li');
        li.textContent = offenses[i];
        pastOffenseList.appendChild(li);
      }
    }
  }

  /* ===== Open/Close Modals ===== */
  if (addViolationBtn) {
    addViolationBtn.addEventListener("click", function () {
      if (!violationForm || !violationModal) return;
      violationForm.reset();
      if (editIndexInput) editIndexInput.value = "";
      if (modalTitle) modalTitle.textContent = "Add Violation";
      if (window._evidence && window._evidence.clear) window._evidence.clear();

      // reset past offense block
      if (pastOffenseWrap) pastOffenseWrap.classList.add('is-hidden');
      if (pastOffenseList) pastOffenseList.innerHTML = '';
      if (pastOffenseEmpty) { pastOffenseEmpty.textContent = 'No past offenses.'; pastOffenseEmpty.classList.remove('is-hidden'); }

      violationModal.style.display = "block";
    });
  }

  for (var i=0;i<closeBtns.length;i++){
    closeBtns[i].addEventListener("click", function () {
      if (violationModal) violationModal.style.display = "none";
      if (viewModal) viewModal.style.display = "none";
    });
  }

  /* ===== Save form ===== */
  if (violationForm) {
    violationForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      var studentName   = (studentNameInput && studentNameInput.value || "").trim();
      var gradeSection  = (gradeSectionInput && gradeSectionInput.value || "").trim();
      var violationType = (violationTypeInput && violationTypeInput.value || "").trim();
      var sanction      = (sanctionInput && sanctionInput.value || "").trim();
      var description   = (descriptionInput && descriptionInput.value || "").trim();
      var date          = (dateInput && dateInput.value) || "";

      // Label to append to mock store so history updates next time
      var parts = [];
      if (description) parts.push(description);
      if (violationType) parts.push(violationType);
      if (sanction) parts.push("Sanction: " + sanction);
      var label = parts.join(" | ") + (date ? " — " + date : "");

      var offensesAfter = [];
      if (studentName) offensesAfter = await PastOffenseService.addOffense(studentName, label, date);

      var violationData = {
        studentName: studentName,
        gradeSection: gradeSection,
        pastOffense: offensesAfter.length ? offensesAfter.join(' • ') : 'No past offenses.',
        date: date,
        description: description,           // stored for modal only
        violationType: violationType,
        sanction: sanction,
        evidence: (window._evidence && window._evidence.get) ? window._evidence.get() : []
      };

      if (!editIndexInput || editIndexInput.value === "") {
        violations.push(violationData);
      } else {
        violations[editIndexInput.value] = violationData;
      }

      renderTable();
      if (violationModal) violationModal.style.display = "none";
      window.dispatchEvent(new Event('sdms:data-changed'));
    });
  }

  /* ===== Render table (description hidden) ===== */
  function renderTable() {
    if (!violationTable) return;
    violationTable.innerHTML = "";

    for (var i=0;i<violations.length;i++){
      var item = violations[i];
      var hasAttach = item.evidence && item.evidence.length > 0;
      var paperclip = hasAttach ? '<span class="has-attachment" title="Has evidence"><i class="fa fa-paperclip"></i></span>' : "";

      var tr = document.createElement("tr");
      tr.innerHTML =
        '<td>' + (item.studentName || '') + ' ' + paperclip + '</td>' +
        '<td>' + (item.gradeSection || '-') + '</td>' +
        '<td>' + (item.pastOffense || 'No past offenses.') + '</td>' +
        '<td>' + (item.date || '-') + '</td>' +
        // description intentionally omitted from table
        '<td>' + (item.violationType || '-') + '</td>' +
        '<td>' + (item.sanction || '-') + '</td>' +
        '<td>' +
          '<button onclick="viewViolationDetails(' + i + ')" title="View"><i class="fa fa-eye"></i></button> ' +
          '<button onclick="editViolation(' + i + ')" title="Edit"><i class="fa fa-edit"></i></button> ' +
          '<button onclick="deleteViolation(' + i + ')" title="Delete"><i class="fa fa-trash"></i></button>' +
        '</td>';
      violationTable.appendChild(tr);
    }
  }

  /* ===== View / Edit / Delete ===== */
  window.viewViolationDetails = function (index) {
    if (!viewModal) return;
    var item = violations[index] || {};
    if (viewStudent)      viewStudent.textContent = item.studentName || '-';
    if (viewGradeSection) viewGradeSection.textContent = item.gradeSection || '-';

    var offenseText = item.pastOffense || 'No past offenses.';
    if (viewPastOffense)  viewPastOffense.textContent = offenseText;
    if (viewPastOffenseRow) viewPastOffenseRow.classList.toggle('is-hidden', !offenseText || offenseText === 'No past offenses.');

    if (viewViolationType) viewViolationType.textContent = item.violationType || '-';
    if (viewSanction)     viewSanction.textContent = item.sanction || '-';
    if (viewDescription)  viewDescription.textContent = item.description || "No description provided.";
    if (viewDate)         viewDate.textContent = item.date || '-';

    if (viewEvidenceBox && viewEvidenceWrap) {
      viewEvidenceBox.innerHTML = "";
      if (item.evidence && item.evidence.length) {
        for (var i=0;i<item.evidence.length;i++){
          (function(src){
            var img = document.createElement("img");
            img.src = src; img.className = "evidence-thumb"; img.alt = "Evidence";
            img.title = "Click to open";
            img.addEventListener("click", function(){ window.open(src, "_blank"); });
            viewEvidenceBox.appendChild(img);
          })(item.evidence[i]);
        }
        viewEvidenceWrap.classList.remove("is-hidden");
      } else {
        viewEvidenceWrap.classList.add("is-hidden");
      }
    }
    viewModal.style.display = "block";
  };

  window.editViolation = function (index) {
    if (!violationModal) return;
    var item = violations[index] || {};
    if (studentNameInput)   studentNameInput.value = item.studentName || '';
    if (gradeSectionInput)  gradeSectionInput.value = item.gradeSection || '';
    if (violationTypeInput) violationTypeInput.value = item.violationType || '';
    if (sanctionInput)      sanctionInput.value = item.sanction || '';
    if (descriptionInput)   descriptionInput.value = item.description || '';
    if (dateInput)          dateInput.value = item.date || '';
    if (editIndexInput)     editIndexInput.value = index;

    refreshPastOffenseUI();
    if (window._evidence && window._evidence.set) window._evidence.set(item.evidence || []);

    if (modalTitle) modalTitle.textContent = "Edit Violation";
    violationModal.style.display = "block";
  };

  window.deleteViolation = function (index) {
    if (!confirm("Are you sure you want to delete this violation?")) return;
    violations.splice(index, 1);
    renderTable();
    window.dispatchEvent(new Event('sdms:data-changed'));
  };

  /* ===== Search ===== */
  window.searchViolation = function () {
    if (!violationTable) return;
    var input = document.getElementById("searchInput");
    var filter = (input && input.value || "").toLowerCase();
    var rows = violationTable.getElementsByTagName("tr");
    for (var i=0;i<rows.length;i++){
      var text = rows[i].textContent.toLowerCase();
      rows[i].style.display = text.indexOf(filter) !== -1 ? "" : "none";
    }
  };

  /* ===== Init ===== */
  renderTable();

  // ensure hidden on load
  if (pastOffenseWrap) pastOffenseWrap.classList.add('is-hidden');
  if (pastOffenseList) pastOffenseList.innerHTML = '';
  if (pastOffenseEmpty) pastOffenseEmpty.textContent = 'No past offenses.';

  // show/update offenses after typing a name
  if (studentNameInput) studentNameInput.addEventListener("input", debounce(refreshPastOffenseUI, 250));

  // programmatic selection hook
  document.addEventListener('studentSelected', function (e) {
    var name = e && e.detail && e.detail.name || '';
    if (name && studentNameInput) studentNameInput.value = name;
    refreshPastOffenseUI();
  });

  var logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) logoutBtn.addEventListener("click", function () { window.location.href = "index.html"; });
});
</script>
</body>
</html>

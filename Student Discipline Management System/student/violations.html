<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SDMS - My Violations</title>
  <link rel="stylesheet" href="css/student.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/auth.js"></script>
  <script src="js/student_auth_guard.js"></script>
</head>
<body>
  <button class="sidebar-toggle" id="sidebarToggle"><i class="fa fa-bars"></i></button>
  <aside class="sidebar">
    <img src="../images/mpnag_logo.png" alt="School Logo" class="logo"/>
  <a href="student_dashboard.html"><i class="fa fa-gauge"></i> Dashboard</a>
  <a href="violations.html" class="active"><i class="fa fa-exclamation-triangle"></i> My Violations</a>
  <a href="appeals.html"><i class="fa fa-file-circle-question"></i> Appeals</a>
  <a href="messages.html"><i class="fa fa-envelope"></i> Messages</a>
    <a href="../index.html" class="logout"><i class="fa fa-right-from-bracket"></i> Logout</a>
  </aside>
  <div class="backdrop" id="sidebarBackdrop"></div>
  <main class="main">
    <header class="topbar">
      <div class="title">
        <h1>Student Discipline Management System</h1>
        <span class="subtitle">My Violations</span>
      </div>
    </header>
    <section class="grid-2">
      <div class="panel"><div class="panel-header"><h3>My Violations Over Time</h3></div><canvas id="lineChart" height="140"></canvas></div>
      <div class="panel"><div class="panel-header"><h3>Violation Breakdown</h3></div><canvas id="barChart" height="140"></canvas></div>
    </section>
    <section class="filters">
      <div class="row">
        <div class="field"><label for="fromDate">From</label><input type="date" id="fromDate"/></div>
        <div class="field"><label for="toDate">To</label><input type="date" id="toDate"/></div>
        <div class="field"><label for="typeFilter">Type</label>
          <select id="typeFilter">
            <option value="All">All</option>
            <option value="Tardiness">Tardiness</option>
            <option value="No ID">No ID</option>
            <option value="Uniform">Uniform</option>
            <option value="Disrespect">Disrespect</option>
            <option value="Cheating">Cheating</option>
          </select>
        </div>
        <button id="applyBtn" class="btn primary"><i class="fa fa-filter"></i> Apply</button>
        <button id="resetBtn" class="btn"><i class="fa fa-rotate-left"></i> Reset</button>
      </div>
    </section>
    <section class="panel">
      <div class="panel-header"><h3>Violation History</h3></div>
      <div class="table-wrap">
        <table class="table"><thead><tr><th>Date</th><th>Type</th><th>Remarks</th><th>Status</th></tr></thead><tbody id="violationRows"></tbody></table>
      </div>
    </section>
  </main>
  <script type="module">
    import { api, getStudentId } from './js/api.js';
  // `violations` is an array when data was fetched successfully, `[]` when there are none,
  // and `null` when the fetch failed (connection/server error).
  let violations = [];
    let lineChart, barChart;
    let currentStudentId = null;

    // Load student profile and show name/grade in the page header
    async function loadProfile(studentId){
          try {
            // Prefer client-side auth user when available (less error-prone than numeric DB id)
            const authUser = window.SDMSAuth && typeof window.SDMSAuth.getUser === 'function' ? window.SDMSAuth.getUser() : null;
            if (authUser) return authUser;

            if (!studentId) return null;

            // Try fetching by id first. Some tokens contain numeric DB id, others contain LRN which
            // won't match the DB id column. If fetch returns 404, fallback to listing students
            // and match by `lrn` or `id`.
            try {
              const profile = await api(`/students/${encodeURIComponent(studentId)}`);
              return profile;
            } catch (err) {
              // If not found, attempt a best-effort lookup by LRN against the students list
              if (err && /404/.test(err.message || '')) {
                try {
                  const list = await api(`/students?page=1&limit=500`);
                  const rows = Array.isArray(list?.data) ? list.data : (Array.isArray(list) ? list : []);
                  const found = rows.find(r => String(r.lrn) === String(studentId) || String(r.id) === String(studentId));
                  if (found) return found;
                } catch (ee) {
                  // swallow — we'll log below
                }
              }
              console.warn('Failed to load student profile', err);
              return null;
            }
          } catch (e) {
            console.warn('Failed to load student profile', e);
            return null;
          }
    }

    function updateProfileUI(profile){
      if (!profile) return;
      try {
        const titleEl = document.querySelector('.title');
        if (!titleEl) return;
        // avoid duplicating if run multiple times
        let meta = document.getElementById('studentProfileMeta');
        let selector = document.getElementById('studentSelector');
        if (!meta) {
          meta = document.createElement('div');
          meta.id = 'studentProfileMeta';
          meta.style.marginTop = '6px';
          meta.style.fontSize = '0.95rem';
          titleEl.appendChild(meta);
        }
        if (!selector) {
          selector = document.createElement('select');
          selector.id = 'studentSelector';
          selector.style.display = 'none';
          selector.style.marginTop = '6px';
          titleEl.appendChild(selector);
        }
        const fullName = [profile.first_name, profile.middle_name, profile.last_name].filter(Boolean).join(' ').trim() || (profile.full_name || 'Student');
        const grade = profile.grade ? `Grade ${profile.grade}` : '';
        const section = profile.section ? `Section ${profile.section}` : '';
        meta.innerHTML = `<strong style="display:block">${fullName}</strong><small style="color:var(--muted, #666)">${grade}${grade && section ? ' • ' : ''}${section}</small>`;

        // Populate selector if linked accounts are present
        const linked = Array.isArray(profile.linked_accounts) && profile.linked_accounts.length ? profile.linked_accounts : (profile.accounts || null);
        if (linked && linked.length > 1) {
          selector.innerHTML = '';
          linked.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.id || a.student_id || a.lrn || a.account_id || a.id;
            opt.textContent = a.displayName || ( (a.first_name||a.full_name) ? `${(a.first_name||a.full_name)}${a.last_name ? ' ' + a.last_name : ''}` : (a.lrn || a.id) );
            selector.appendChild(opt);
          });
          selector.value = currentStudentId || selector.options[0].value;
          selector.style.display = '';
          selector.onchange = () => {
            currentStudentId = selector.value;
            loadViolations(currentStudentId);
          };
        } else {
          selector.style.display = 'none';
        }
      } catch (e) { console.warn('updateProfileUI error', e); }
    }

    async function loadViolations(){
      // allow selector to control student id; fall back to getStudentId()
      const studentId = currentStudentId || getStudentId();
      currentStudentId = studentId || currentStudentId || 'me';
      // load profile (best-effort) and update UI
      try {
        const profile = await loadProfile(currentStudentId || 'me');
        // if auth user provides linked accounts merge minimally
        const authUser = window.SDMSAuth && typeof window.SDMSAuth.getUser === 'function' ? window.SDMSAuth.getUser() : null;
        if (authUser && authUser.linked_accounts) { profile.linked_accounts = authUser.linked_accounts; }
        updateProfileUI(profile);
      } catch (e) {
        // continue even if profile fails
      }
      try {
  // Request violations scoped to the logged-in student (use LRN/student_id from getStudentId)
  // The backend expects `student_id` (snake_case) to enforce proper filtering.
  const data = await api(`/violations?student_id=${encodeURIComponent(currentStudentId||'me')}`);
        // Normalize expected shape
        violations = (Array.isArray(data) ? data : data.rows || [])
          .map(v => ({
            date: (v.date || v.created_at || '').slice(0,10),
            type: v.type || v.violation_type || v.offense || 'Unknown',
            remarks: v.remarks || v.description || '',
            status: (v.status || 'Pending')
          }));
        renderTable(violations);
        renderCharts(violations);
      } catch (e){
        console.error(e);
        // Distinguish 'no violations' (empty array) vs 'fetch failed' (null)
        violations = null;
        renderTable(null);
        renderCharts(null);
      }
    }

    function renderTable(rows){
      const tbody=document.getElementById('violationRows');
      tbody.innerHTML='';
      if (rows === null) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);">Violation data unavailable (could not connect to server)</td></tr>';
        return;
      }
      rows.forEach(v=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${v.date}</td><td>${v.type}</td><td>${v.remarks}</td><td><span class="status ${v.status.toLowerCase()}">${v.status}</span></td>`;tbody.appendChild(tr);});
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No violations found</td></tr>';
      }
    }

    function renderCharts(rows){
      if(lineChart) lineChart.destroy();
      if(barChart) barChart.destroy();
      if (rows === null || !rows.length) {
        // Render empty clean charts (no gridlines/labels) to keep layout stable when data is unavailable
        lineChart = new Chart(document.getElementById('lineChart'), {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'Violations',
              data: [],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231,76,60,0.3)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            responsive: true,
            scales: {
              x: { grid: { display: false }, ticks: { display: false } },
              y: { grid: { display: false }, ticks: { display: false } }
            }
          }
        });
        barChart = new Chart(document.getElementById('barChart'), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{ label: 'Count', data: [], backgroundColor: [] }]
          },
          options: {
            plugins: { legend: { display: false } },
            responsive: true,
            scales: {
              x: { grid: { display: false }, ticks: { display: false } },
              y: { grid: { display: false }, ticks: { display: false } }
            }
          }
        });
        return;
      }
      const labels=rows.map(v=>v.date);const counts=rows.map((_,i)=>i+1);
  lineChart = new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Violations',
        data: counts,
        borderColor: '#e74c3c',
        backgroundColor: 'rgba(231,76,60,0.3)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      responsive: true,
      scales: {
        x: { grid: { display: false }, ticks: { display: false } },
        y: { grid: { display: false }, ticks: { display: false } }
      }
    }
  });
      const byType = {};
      rows.forEach(v => { byType[v.type] = (byType[v.type] || 0) + 1 });
  barChart = new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: Object.keys(byType),
      datasets: [{
        label: 'Count',
        data: Object.values(byType),
        backgroundColor: ['#3498db', '#9b59b6', '#f1c40f', '#e67e22', '#e74c3c']
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      responsive: true,
      scales: {
        x: { grid: { display: false }, ticks: { display: false } },
        y: { grid: { display: false }, ticks: { display: false } }
      }
    }
  });
    }

    function applyFilters(){
      const from=document.getElementById('fromDate').value;
      const to=document.getElementById('toDate').value;
      const type=document.getElementById('typeFilter').value;
      let filtered=violations.slice();
      if(from) filtered=filtered.filter(v=>v.date>=from);
      if(to) filtered=filtered.filter(v=>v.date<=to);
      if(type!=='All') filtered=filtered.filter(v=>v.type===type);
      renderTable(filtered);renderCharts(filtered);
    }
    function resetFilters(){
      document.getElementById('fromDate').value='';
      document.getElementById('toDate').value='';
      document.getElementById('typeFilter').value='All';
      renderTable(violations);renderCharts(violations);
    }
    document.getElementById('applyBtn').addEventListener('click',applyFilters);
    document.getElementById('resetBtn').addEventListener('click',resetFilters);
    // initial load (selector will be populated if profile or auth user supplies linked accounts)
    loadViolations();
   </script>
  <script src="js/sidebar.js"></script>
  <script src="js/main.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SDMS - Dashboard</title>
  <link rel="stylesheet" href="css/student.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/auth.js"></script>
  <script src="js/student_auth_guard.js"></script>
</head>
<body>
  <button class="sidebar-toggle" id="sidebarToggle"><i class="fa fa-bars"></i></button>
  <aside class="sidebar">
    <img src="../images/mpnag_logo.png" alt="School Logo" class="logo"/>
    <a href="student_dashboard.html" class="active"><i class="fa fa-gauge"></i> Dashboard</a>
    <a href="violations.html"><i class="fa fa-exclamation-triangle"></i> My Violations</a>
    <a href="messages.html"><i class="fa fa-envelope"></i> Messages</a>
    <a href="appeals.html"><i class="fa fa-file-circle-question"></i> Appeals</a>
    <a href="about.html"><i class="fa fa-circle-info"></i> About & Concept</a>
    <a href="../index.html" class="logout"><i class="fa fa-right-from-bracket"></i> Logout</a>
  </aside>
  <div class="backdrop" id="sidebarBackdrop"></div>
  <main class="main">
    <header class="topbar">
      <div class="title">
        <h1>Student Discipline Management System</h1>
        <span class="subtitle">Student Dashboard</span>
      </div>
      <div class="profile">
        <div class="name-grade">
          <strong>Juan Dela Cruz</strong>
          <small>Grade 9 • Section Emerald</small>
        </div>
  <img src="../images/mpnag_logo.png" alt="Avatar" class="avatar"/>
      </div>
    </header>
    <section class="cards">
      <div class="card"><i class="fa fa-exclamation-circle"></i><h2 id="totalViolations">0</h2><p>Total Violations</p></div>
      <div class="card"><i class="fa fa-folder-open"></i><h2 id="openCases">0</h2><p>Open Cases</p></div>
      <div class="card"><i class="fa fa-calendar"></i><h2 id="lastViolation">—</h2><p>Last Violation</p></div>
      <div class="card"><i class="fa fa-user-check"></i><span class="status" id="studentStatus">Good Standing</span><p>Status</p></div>
    </section>
    <section class="grid-2">
      <div class="panel"><div class="panel-header"><h3>My Violations Over Time</h3></div><canvas id="lineChart" height="140"></canvas></div>
      <div class="panel"><div class="panel-header"><h3>Violation Breakdown</h3></div><canvas id="barChart" height="140"></canvas></div>
    </section>
    <section class="panel">
      <div class="panel-header"><h3>Violation History</h3></div>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>Date</th><th>Type</th><th>Remarks</th><th>Status</th></tr></thead>
          <tbody id="violationRows"></tbody>
        </table>
      </div>
    </section>
  </main>
  <script type="module">
    import { api, getStudentId } from './js/api.js';
    let violations = [];
    let lineChart, barChart;

    function updateCards(){
      const open = violations.filter(v=> (v.status||'').toLowerCase() === 'pending').length;
      document.getElementById('totalViolations').textContent = violations.length;
      document.getElementById('openCases').textContent = open;
      document.getElementById('lastViolation').textContent = violations.length ? violations[violations.length-1].date : '—';
      document.getElementById('studentStatus').textContent = open>=3 ? 'On Probation' : 'Good Standing';
    }
    function renderTable(){
      const tbody = document.getElementById('violationRows');
      tbody.innerHTML='';
      violations.forEach(v=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${v.date}</td><td>${v.type}</td><td>${v.remarks}</td><td><span class="status ${ (v.status||'').toLowerCase() }">${v.status}</span></td>`;
        tbody.appendChild(tr);
      });
      if(!violations.length){
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No violations yet</td></tr>';
      }
    }
    function renderCharts(){
      if(lineChart) lineChart.destroy();
      if(barChart) barChart.destroy();
      const labels = violations.map(v=>v.date);
      const counts = violations.map((_,i)=>i+1);
      lineChart = new Chart(document.getElementById('lineChart'),{type:'line',data:{labels,datasets:[{label:'Violations',data:counts,borderColor:'#e74c3c',backgroundColor:'rgba(231,76,60,0.3)',fill:true,tension:0.3}]},options:{plugins:{legend:{display:false}},responsive:true}});
      const byType={}; violations.forEach(v=>{byType[v.type]=(byType[v.type]||0)+1});
      barChart = new Chart(document.getElementById('barChart'),{type:'bar',data:{labels:Object.keys(byType),datasets:[{label:'Count',data:Object.values(byType),backgroundColor:['#3498db','#9b59b6','#f1c40f','#e67e22','#e74c3c']}]},options:{plugins:{legend:{display:false}},responsive:true}});
    }
    async function loadData(){
      const studentId = getStudentId();
      try {
        const data = await api(`/violations?studentId=${encodeURIComponent(studentId||'me')}`);
        violations = (Array.isArray(data) ? data : data.rows || []).map(v=>({
          date: (v.date || v.created_at || '').slice(0,10),
            type: v.type || v.violation_type || v.offense || 'Unknown',
            remarks: v.remarks || v.description || '',
            status: v.status || 'Pending'
        }));
      } catch (e){
        console.error('Failed to load violations for dashboard', e);
        violations = [];
      }
      updateCards();
      renderTable();
      renderCharts();
    }
    loadData();
  </script>
  <script src="js/sidebar.js"></script>
  <script src="js/main.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SDMS - Dashboard</title>

  <!-- Global Styles -->
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar" aria-hidden="true">
  <img src="images/mpnag_logo.png" alt="MPNAG Logo"
       style="width:80px;display:block;margin:0 auto 12px;">

  <a href="dashboard.html" class="active"><i class="fa fa-gauge"></i> Dashboard</a>
  <a href="student_list.html"><i class="fa fa-users"></i> Student List</a>
  <a href="violation_list.html"><i class="fa fa-exclamation-triangle"></i> Violation List</a>
  <a href="SMS.html"><i class="fa fa-message"></i> Message</a>
  <a href="create_account.html"><i class="fa fa-user-plus"></i> Accounts</a>

  <div class="sidebar-footer">
    <button id="logoutBtn" class="logout-side" type="button">
      <i class="fa fa-sign-out-alt" aria-hidden="true"></i>
      <span>Logout</span>
    </button>
  </div>
</nav>

<div class="backdrop" id="backdrop" aria-hidden="true"></div>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <button class="menu-btn" aria-label="Open menu" aria-controls="sidebar" aria-expanded="false">
      <i class="fa fa-bars" aria-hidden="true"></i><span> Menu</span>
    </button>
    <h1>Student Discipline Management System</h1>

    <div class="user-area">
      <button class="user-chip" id="userChip" type="button" aria-label="Current user">
        <span class="user-avatar" id="userAvatar">?</span>
        <span class="user-name" id="userName">User</span>
      </button>
    </div>
  </div>

  <!-- KPI Section -->
  <div class="kpi-grid">
    <div class="kpi card">
      <div class="kpi-icon"><i class="fa fa-users"></i></div>
      <div class="kpi-body">
        <div class="kpi-label">Students</div>
        <div class="kpi-value" id="totalStudents">—</div>
        <div class="kpi-sub">Registered</div>
      </div>
    </div>

    <div class="kpi card">
      <div class="kpi-icon warn"><i class="fa fa-exclamation-triangle"></i></div>
      <div class="kpi-body">
        <div class="kpi-label">Violations</div>
        <div class="kpi-value" id="violations30">—</div>
        <div class="kpi-sub">Last 30 days</div>
      </div>
    </div>

    <div class="kpi card">
      <div class="kpi-icon info"><i class="fa fa-clipboard-list"></i></div>
      <div class="kpi-body">
        <div class="kpi-label">Open Cases</div>
        <div class="kpi-value" id="openCases">—</div>
        <div class="kpi-sub">Needing follow-up</div>
      </div>
    </div>

    <div class="kpi card">
      <div class="kpi-icon danger"><i class="fa fa-user-times"></i></div>
      <div class="kpi-body">
        <div class="kpi-label">Repeat Offenders</div>
        <div class="kpi-value" id="repeatOffenders">—</div>
        <div class="kpi-sub">≥ 3 violations (90d)</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters card">
    <div class="filters-row">
      <div class="field">
        <label for="dateFrom">From</label>
        <input type="date" id="dateFrom" />
      </div>
      <div class="field">
        <label for="dateTo">To</label>
        <input type="date" id="dateTo" />
      </div>
      <div class="field">
        <label for="filterGrade">Grade</label>
        <select id="filterGrade"><option value="">All</option></select>
      </div>
      <div class="field">
        <label for="filterSection">Section</label>
        <select id="filterSection"><option value="">All</option></select>
      </div>
      <div class="field">
        <label for="filterType">Violation</label>
        <select id="filterType"><option value="">All</option></select>
      </div>
      <div class="buttons">
        <button id="btnQuick7" class="btn subtle">Last 7d</button>
        <button id="btnQuick30" class="btn subtle">Last 30d</button>
        <button id="btnReset" class="btn outline">Reset</button>
        <button id="btnApply" class="btn primary"><i class="fa fa-filter"></i> Apply</button>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="card">
      <div class="card-header">
        <h3>Violations Over Time</h3>
        <span class="hint" id="rangeHint"></span>
      </div>
      <div class="chart-wrap"><canvas id="chartTrend"></canvas></div>
      <div class="empty hidden" id="emptyTrend">No data available.</div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Top Violation Types</h3>
        <span class="hint" id="typesHint"></span>
      </div>
      <div class="chart-wrap"><canvas id="chartTopTypes"></canvas></div>
      <div class="empty hidden" id="emptyTypes">No data available.</div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Violations by Grade</h3>
        <span class="hint">Current Filters</span>
      </div>
      <div class="chart-wrap"><canvas id="chartByGrade"></canvas></div>
      <div class="empty hidden" id="emptyByGrade">No data available.</div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="js/app.js" defer></script>
<script src="js/dashboard.js" defer></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const sidebar  = document.getElementById('sidebar');
  const menuBtn  = document.querySelector('.menu-btn');
  const backdrop = document.getElementById('backdrop');
  const logoutBtn = document.getElementById('logoutBtn');

  const setOpen = (open) => {
    sidebar.classList.toggle('open', open);
    backdrop.classList.toggle('show', open);
    document.body.style.overflow = open ? 'hidden' : '';
    menuBtn?.setAttribute('aria-expanded', String(open));
  };

  menuBtn?.addEventListener('click', () => setOpen(!sidebar.classList.contains('open')));
  backdrop?.addEventListener('click', () => setOpen(false));
  window.addEventListener('resize', () => { if (innerWidth >= 769) setOpen(false); });

  logoutBtn?.addEventListener('click', () => {
    // Clear local session or token before redirecting
    localStorage.removeItem('sdms_token');
    localStorage.removeItem('sdms_user');
    window.location.href = 'index.html';
  });

  // === Fetch user info from backend ===
  try {
    const res = await fetch('/api/user/profile', { headers: { 'Authorization': `Bearer ${localStorage.getItem('sdms_token')}` }});
    if (res.ok) {
      const user = await res.json();
      document.getElementById('userName').textContent = user.name || 'User';
      document.getElementById('userAvatar').textContent = (user.name?.[0] || 'U').toUpperCase();
    }
  } catch (err) {
    console.error('Failed to load user info', err);
  }

  // === Fetch KPI Metrics ===
  try {
    const res = await fetch('/api/dashboard/metrics');
    if (res.ok) {
      const data = await res.json();
      document.getElementById('totalStudents').textContent = data.totalStudents ?? '—';
      document.getElementById('violations30').textContent = data.violationsLast30 ?? '—';
      document.getElementById('openCases').textContent = data.openCases ?? '—';
      document.getElementById('repeatOffenders').textContent = data.repeatOffenders ?? '—';
    }
  } catch (err) {
    console.error('Failed to load metrics', err);
  }

  // === Fetch Chart Data ===
  try {
    const res = await fetch('/api/dashboard/charts');
    if (res.ok) {
      const chartData = await res.json();
      renderCharts(chartData);
    }
  } catch (err) {
    console.error('Failed to load chart data', err);
  }
});

// ===== Chart.js setup (backend data injected) =====
function renderCharts(data) {
  const trendCtx = document.getElementById('chartTrend').getContext('2d');
  const typesCtx = document.getElementById('chartTopTypes').getContext('2d');
  const gradeCtx = document.getElementById('chartByGrade').getContext('2d');

  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: data.trend?.labels || [],
      datasets: [{
        label: 'Violations',
        data: data.trend?.values || []
      }]
    }
  });

  new Chart(typesCtx, {
    type: 'bar',
    data: {
      labels: data.topTypes?.labels || [],
      datasets: [{
        label: 'Count',
        data: data.topTypes?.values || []
      }]
    }
  });

  new Chart(gradeCtx, {
    type: 'bar',
    data: {
      labels: data.byGrade?.labels || [],
      datasets: [{
        label: 'Violations',
        data: data.byGrade?.values || []
      }]
    }
  });
}
</script>
</body>
</html>
